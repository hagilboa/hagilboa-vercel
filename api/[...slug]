<?php
$uri = $_SERVER['REQUEST_URI'];
$shortCode = urldecode(trim($uri, '/'));

// ?? ?? ???? ?-API, ???
if (strpos($uri, '/api/') === 0) {
    return;
}

header('Content-Type: text/html; charset=UTF-8');

if (empty($shortCode)) {
    echo '<h1 style="text-align:center; color:#2c5aa0;">?? GILBOA.LINK</h1>';
    echo '<p style="text-align:center; color:#666;">????? ????? ??????? ?? ????? ?????? ??????</p>';
    exit;
}

// ?????? Google Sheets
$spreadsheetId = '1YqXyxKGIjXSHQgN8ok2JKbBf87SIMaBMWCJ72-NSbw8';
$apiKey = 'AIzaSyAwPN3u1IUd3HL3Q7LwJKemep8dBsU_R5M';

// ????? ????? ????
$url = "https://sheets.googleapis.com/v4/spreadsheets/{$spreadsheetId}/values/URL!A:G?key={$apiKey}";
$response = @file_get_contents($url);

if ($response !== false) {
    $data = json_decode($response, true);
    
    if (isset($data['values'])) {
        foreach ($data['values'] as $rowIndex => $row) {
            if ($rowIndex == 0) continue; // ??? ?? ?????
            
            // ???? ?? ????? C (????) ????? ?? ???? ????
            if (isset($row[2]) && $row[2] == $shortCode) {
                if (isset($row[1]) && !empty($row[1])) {
                    header("Location: " . $row[1], true, 301);
                    exit;
                }
            }
        }
    }
}

header("HTTP/1.0 404 Not Found");
echo '<h1 style="text-align:center; color:#d63384;">? ?????? ?? ????</h1>';
echo '<p style="text-align:center;"><a href="https://hagilboa.link" style="color:#2c5aa0;">???? ????? ????</a></p>';
?>